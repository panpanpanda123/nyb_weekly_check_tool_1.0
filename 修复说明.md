# 门店评级系统修复说明

## 问题诊断

### 现象
1. 页面能打开但没有UI样式
2. 筛选下拉菜单为空
3. 完成率统计为空

### 根本原因
1. **端口不匹配**: 服务运行在8001端口，但Nginx配置可能还是8000
2. **评级显示问题**: API返回的是完整对象而不是rating字符串（已在本地修复）

## 已完成的修复

### 1. 修复评级显示逻辑 ✅
**文件**: `rating_app.py` (第165-171行)

**问题**: `ratings.json` 存储格式是 `{store_id: {rating: 'A', updated_at: '...'}}`，但API直接返回了整个对象

**修复**: 提取 `rating` 字段
```python
# 修复前
store['current_rating'] = ratings.get(store_id, '')

# 修复后
rating_data = ratings.get(store_id, {})
if isinstance(rating_data, dict):
    store['current_rating'] = rating_data.get('rating', '')
else:
    store['current_rating'] = rating_data if rating_data else ''
```

### 2. 统一端口配置 ✅
**文件**: `rating_app.py` (最后一行)

**修复**: 将端口从8000改为8001
```python
app.run(host='0.0.0.0', port=8001, debug=False)
```

### 3. 创建部署文档 ✅
- `deploy/rating_deploy_guide.md` - 完整部署和故障排查指南
- `服务器快速部署.md` - 快速参考指南（已更新端口）
- `upload_rating_fix.bat` - 一键修复上传脚本

## 立即修复步骤

### 最简单方式：运行一键脚本

```bash
upload_rating_fix.bat
```

这个脚本会自动完成所有修复步骤。

### 手动修复步骤

如果脚本无法运行，按以下步骤手动操作：

#### 步骤1: 上传修复后的代码
```bash
scp rating_app.py root@blitzepanda.top:/opt/review-result-viewer/
```

#### 步骤2: 确认数据文件存在
```bash
# 检查文件
ssh root@blitzepanda.top "ls -lh /opt/review-result-viewer/rating_data/stores.json"

# 如果不存在或太小，上传
scp rating_data/stores.json root@blitzepanda.top:/opt/review-result-viewer/rating_data/
```

#### 步骤3: 修复Nginx端口配置
```bash
ssh root@blitzepanda.top

# 修改端口配置
sed -i 's|proxy_pass http://127.0.0.1:8000|proxy_pass http://127.0.0.1:8001|g' /etc/nginx/sites-available/default

# 测试配置
nginx -t

# 重载Nginx
systemctl reload nginx
```

#### 步骤4: 重启评级服务
```bash
systemctl restart rating

# 等待3秒
sleep 3

# 检查状态
systemctl status rating
```

#### 步骤5: 验证修复
```bash
# 测试API
curl http://127.0.0.1:8001/api/rating/war-zones

# 应该返回JSON格式的战区列表
```

## 验证清单

修复后，请验证以下项目：

- [ ] 服务运行正常: `systemctl status rating` 显示 `active (running)`
- [ ] 端口监听正确: `netstat -tlnp | grep 8001` 显示python3在监听
- [ ] API响应正常: `curl http://127.0.0.1:8001/api/rating/war-zones` 返回JSON
- [ ] 外网可访问: `curl http://blitzepanda.top/api/rating/war-zones` 返回JSON
- [ ] 静态文件正常: `curl -I http://blitzepanda.top/static/rating.js` 返回200
- [ ] 页面可以打开: 浏览器访问 `http://blitzepanda.top/rating`
- [ ] 筛选功能正常: 下拉菜单显示战区和区域经理选项
- [ ] 门店列表正常: 点击搜索后显示门店卡片
- [ ] 评级功能正常: 点击A/B/C按钮可以提交评级
- [ ] 评级状态显示: 已评级的门店显示当前评级

## 如果仍有问题

### 查看日志
```bash
# 应用日志
ssh root@blitzepanda.top "tail -50 /opt/review-result-viewer/logs/rating_app.log"

# 系统日志
ssh root@blitzepanda.top "journalctl -u rating -n 50"

# Nginx日志
ssh root@blitzepanda.top "tail -50 /var/log/nginx/error.log"
```

### 检查Nginx配置
```bash
ssh root@blitzepanda.top "cat /etc/nginx/sites-available/default | grep -A 10 'location /rating'"
```

应该显示：
```nginx
location /rating {
    proxy_pass http://127.0.0.1:8001;  # 注意端口是8001
    ...
}

location /api/rating {
    proxy_pass http://127.0.0.1:8001;  # 注意端口是8001
    ...
}

location /static/ {
    alias /opt/review-result-viewer/viewer/static/;  # 注意末尾的斜杠
    ...
}
```

### 检查数据文件
```bash
ssh root@blitzepanda.top "ls -lh /opt/review-result-viewer/rating_data/"
```

应该显示：
- `stores.json` - 大小应该 > 100KB（包含2141个门店）
- `ratings.json` - 可能不存在（首次运行时自动创建）

## 后续步骤

修复完成后：

1. **测试完整流程**
   - 打开页面
   - 选择战区和区域经理
   - 点击搜索
   - 为门店评级
   - 导出CSV

2. **提交到Git**
   ```bash
   git add .
   git commit -m "修复评级显示和端口配置问题"
   git push origin main
   ```

3. **备份评级数据**
   ```bash
   scp root@blitzepanda.top:/opt/review-result-viewer/rating_data/ratings.json ./backup/
   ```

## 文件清单

本次修复涉及的文件：

### 修改的文件
- ✅ `rating_app.py` - 修复评级显示逻辑，统一端口为8001
- ✅ `GIT提交指南.md` - 更新部署说明
- ✅ `服务器快速部署.md` - 更新端口信息

### 新增的文件
- ✅ `deploy/rating_deploy_guide.md` - 完整部署指南
- ✅ `upload_rating_fix.bat` - 一键修复脚本
- ✅ `修复说明.md` - 本文档

### 需要上传到服务器的文件
- ✅ `rating_app.py` - 必须上传（包含修复）
- ✅ `rating_data/stores.json` - 如果服务器上不存在或为空

## 技术细节

### 评级数据存储格式
```json
{
  "门店ID": {
    "rating": "A",
    "updated_at": "2026-02-04T12:00:00"
  }
}
```

### API返回格式
```json
{
  "success": true,
  "data": {
    "stores": [
      {
        "store_id": "123",
        "store_name": "测试门店",
        "current_rating": "A"  // 现在正确返回字符串
      }
    ]
  }
}
```

### Nginx配置要点
1. 端口必须是 `8001`
2. `/static/` 路径末尾的斜杠很重要
3. `alias` 路径也要以斜杠结尾

## 总结

本次修复解决了两个关键问题：
1. **评级显示**: 修复了API返回格式，确保前端能正确显示已评级状态
2. **端口配置**: 统一使用8001端口，避免端口冲突

修复后，系统应该能够正常运行，用户可以：
- 看到完整的UI界面
- 使用筛选功能
- 查看门店列表
- 提交评级
- 看到已评级的状态
- 导出评级结果
