# äº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éœ€è¦ä¿®æ”¹çš„åœ°æ–¹

### 1. **ç¡¬ç¼–ç è·¯å¾„é—®é¢˜** âš ï¸ æœ€é‡è¦

å½“å‰ä»£ç ä¸­æœ‰å¤šå¤„ä½¿ç”¨äº†Windowsæœ¬åœ°è·¯å¾„ï¼Œéœ€è¦ä¿®æ”¹ï¼š

#### app.py ä¸­çš„è·¯å¾„ï¼ˆ3å¤„ï¼‰
```python
# ç¬¬278è¡Œã€ç¬¬331è¡Œã€ç¬¬401è¡Œ
whitelist_file = 'D:/pythonproject/Newyobo_operat_database/daily_data/whitelist/whitelist.xlsx'
```

**ä¿®æ”¹æ–¹æ¡ˆ**ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„
```python
from config import WHITELIST_FILE
whitelist_file = WHITELIST_FILE
```

### 2. **æ•°æ®åº“è¿æ¥é…ç½®**

#### database.py
```python
# å½“å‰é…ç½®
DATABASE_URL = os.getenv(
    'DATABASE_URL',
    'postgresql://postgres:postgres@127.0.0.1:5432/configurable_ops'
)
```

**äº‘æœåŠ¡å™¨é…ç½®**ï¼š
- ä¿®æ”¹æ•°æ®åº“å¯†ç ï¼ˆä¸è¦ä½¿ç”¨é»˜è®¤çš„postgresï¼‰
- å¦‚æœæ•°æ®åº“åœ¨å…¶ä»–æœåŠ¡å™¨ï¼Œä¿®æ”¹ä¸»æœºåœ°å€
- ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®

### 3. **Flaskè¿è¡Œé…ç½®**

#### app.py åº•éƒ¨
```python
# å½“å‰é…ç½®
app.run(host='0.0.0.0', port=5001, debug=True)
```

**ä¿®æ”¹ä¸º**ï¼š
```python
from config import HOST, PORT, DEBUG
app.run(host=HOST, port=PORT, debug=DEBUG)
```

### 4. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ–¹å¼**

ä¸è¦ä½¿ç”¨Flaskå†…ç½®æœåŠ¡å™¨ï¼Œåº”è¯¥ä½¿ç”¨ï¼š
- **Gunicorn** (æ¨è) æˆ–
- **uWSGI**

---

## ğŸš€ å®Œæ•´éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: å‡†å¤‡äº‘æœåŠ¡å™¨ç¯å¢ƒ

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…Python 3.8+
sudo apt install python3 python3-pip python3-venv -y

# å®‰è£…PostgreSQL
sudo apt install postgresql postgresql-contrib -y

# å®‰è£…Nginxï¼ˆå¯é€‰ï¼Œç”¨äºåå‘ä»£ç†ï¼‰
sudo apt install nginx -y
```

### æ­¥éª¤ 2: åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /var/www/inspection_system
cd /var/www/inspection_system

# è®¾ç½®æƒé™
sudo chown -R $USER:$USER /var/www/inspection_system
```

### æ­¥éª¤ 3: ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

```bash
# æ–¹å¼1: ä½¿ç”¨git
git clone <your-repo-url> .

# æ–¹å¼2: ä½¿ç”¨scpä»æœ¬åœ°ä¸Šä¼ 
# åœ¨æœ¬åœ°æ‰§è¡Œï¼š
scp -r /path/to/project/* user@your-server-ip:/var/www/inspection_system/
```

### æ­¥éª¤ 4: é…ç½®Pythonè™šæ‹Ÿç¯å¢ƒ

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£…Gunicorn
pip install gunicorn python-dotenv
```

### æ­¥éª¤ 5: é…ç½®PostgreSQLæ•°æ®åº“

```bash
# åˆ‡æ¢åˆ°postgresç”¨æˆ·
sudo -u postgres psql

# åœ¨PostgreSQLä¸­æ‰§è¡Œï¼š
CREATE DATABASE configurable_ops;
CREATE USER inspection_user WITH PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE configurable_ops TO inspection_user;
\q
```

### æ­¥éª¤ 6: é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
nano .env
```

ä¿®æ”¹ `.env` æ–‡ä»¶ï¼š
```bash
FLASK_ENV=production
DATABASE_URL=postgresql://inspection_user:your_strong_password@localhost:5432/configurable_ops
WHITELIST_FILE=/var/www/inspection_system/data/whitelist.xlsx
SECRET_KEY=ç”Ÿæˆä¸€ä¸ªéšæœºçš„å¯†é’¥
```

### æ­¥éª¤ 7: åˆ›å»ºå¿…è¦çš„ç›®å½•

```bash
mkdir -p data logs uploads
```

### æ­¥éª¤ 8: ä¸Šä¼ ç™½åå•æ–‡ä»¶

```bash
# ä»æœ¬åœ°ä¸Šä¼ ç™½åå•æ–‡ä»¶
scp /path/to/whitelist.xlsx user@your-server-ip:/var/www/inspection_system/data/
```

### æ­¥éª¤ 9: åˆå§‹åŒ–æ•°æ®åº“

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# è¿è¡Œåˆå§‹åŒ–è„šæœ¬
python init_database.py
```

### æ­¥éª¤ 10: æµ‹è¯•è¿è¡Œ

```bash
# ä½¿ç”¨Gunicornæµ‹è¯•
gunicorn -w 4 -b 0.0.0.0:5001 app:app

# åœ¨æµè§ˆå™¨è®¿é—®: http://your-server-ip:5001
```

### æ­¥éª¤ 11: é…ç½®SystemdæœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰

åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼š
```bash
sudo nano /etc/systemd/system/inspection.service
```

å†…å®¹ï¼š
```ini
[Unit]
Description=Store Inspection Review System
After=network.target postgresql.service

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/inspection_system
Environment="PATH=/var/www/inspection_system/venv/bin"
ExecStart=/var/www/inspection_system/venv/bin/gunicorn \
    --workers 4 \
    --bind 0.0.0.0:5001 \
    --timeout 120 \
    --access-logfile /var/www/inspection_system/logs/access.log \
    --error-logfile /var/www/inspection_system/logs/error.log \
    app:app

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl start inspection
sudo systemctl enable inspection
sudo systemctl status inspection
```

### æ­¥éª¤ 12: é…ç½®Nginxåå‘ä»£ç†ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
sudo nano /etc/nginx/sites-available/inspection
```

å†…å®¹ï¼š
```nginx
server {
    listen 80;
    server_name your-domain.com;  # æˆ–ä½¿ç”¨IPåœ°å€

    client_max_body_size 50M;

    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketæ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /static {
        alias /var/www/inspection_system/static;
        expires 30d;
    }
}
```

å¯ç”¨é…ç½®ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/inspection /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### æ­¥éª¤ 13: é…ç½®é˜²ç«å¢™

```bash
# å…è®¸HTTPå’ŒHTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å¦‚æœç›´æ¥è®¿é—®5001ç«¯å£
sudo ufw allow 5001/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### æ­¥éª¤ 14: é…ç½®SSLè¯ä¹¦ï¼ˆæ¨èï¼‰

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx -y

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## ğŸ“ éœ€è¦ä¿®æ”¹çš„ä»£ç æ–‡ä»¶æ¸…å•

### 1. app.py
- [ ] å¯¼å…¥configæ¨¡å—
- [ ] æ›¿æ¢æ‰€æœ‰ç¡¬ç¼–ç çš„whitelist_fileè·¯å¾„ï¼ˆ3å¤„ï¼‰
- [ ] ä¿®æ”¹app.run()é…ç½®
- [ ] æ·»åŠ æ—¥å¿—é…ç½®

### 2. database.py
- [ ] å·²ç»ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œæ— éœ€ä¿®æ”¹

### 3. requirements.txt
- [ ] æ·»åŠ ç”Ÿäº§ç¯å¢ƒä¾èµ–

### 4. æ–°å¢æ–‡ä»¶
- [x] config.py - é…ç½®æ–‡ä»¶
- [x] .env.example - ç¯å¢ƒå˜é‡æ¨¡æ¿
- [ ] gunicorn_config.py - Gunicorné…ç½®

---

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
```python
# requirements.txt æ·»åŠ 
gunicorn==21.2.0
gevent==23.9.1  # å¼‚æ­¥worker
python-dotenv==1.0.0
```

### 2. æ—¥å¿—é…ç½®
```python
# åœ¨app.pyæ·»åŠ 
import logging
from logging.handlers import RotatingFileHandler

if not app.debug:
    file_handler = RotatingFileHandler(
        'logs/app.log', 
        maxBytes=10240000, 
        backupCount=10
    )
    file_handler.setFormatter(logging.Formatter(
        '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
    ))
    file_handler.setLevel(logging.INFO)
    app.logger.addHandler(file_handler)
    app.logger.setLevel(logging.INFO)
    app.logger.info('Inspection system startup')
```

### 3. æ•°æ®åº“è¿æ¥æ± 
```python
# database.py å·²é…ç½®ï¼Œç¡®ä¿ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
SQLALCHEMY_POOL_SIZE=10
SQLALCHEMY_MAX_OVERFLOW=20
```

### 4. å®šæœŸå¤‡ä»½
```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
nano /var/www/inspection_system/backup.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/inspection_system"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
pg_dump -U inspection_user configurable_ops > $BACKUP_DIR/db_$DATE.sql

# å¤‡ä»½ä¸Šä¼ çš„æ–‡ä»¶
tar -czf $BACKUP_DIR/files_$DATE.tar.gz /var/www/inspection_system/uploads

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

æ·»åŠ åˆ°crontabï¼š
```bash
crontab -e
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /var/www/inspection_system/backup.sh
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥PostgreSQLçŠ¶æ€
sudo systemctl status postgresql

# æ£€æŸ¥è¿æ¥
psql -U inspection_user -d configurable_ops -h localhost
```

### 2. æƒé™é—®é¢˜
```bash
# ä¿®å¤æ–‡ä»¶æƒé™
sudo chown -R www-data:www-data /var/www/inspection_system
sudo chmod -R 755 /var/www/inspection_system
```

### 3. æŸ¥çœ‹æ—¥å¿—
```bash
# åº”ç”¨æ—¥å¿—
tail -f /var/www/inspection_system/logs/app.log

# Gunicornæ—¥å¿—
tail -f /var/www/inspection_system/logs/error.log

# Nginxæ—¥å¿—
tail -f /var/log/nginx/error.log

# Systemdæ—¥å¿—
sudo journalctl -u inspection -f
```

### 4. é‡å¯æœåŠ¡
```bash
# é‡å¯åº”ç”¨
sudo systemctl restart inspection

# é‡å¯Nginx
sudo systemctl restart nginx

# é‡å¯PostgreSQL
sudo systemctl restart postgresql
```

---

## ğŸ“Š ç›‘æ§å»ºè®®

### 1. ç³»ç»Ÿç›‘æ§
```bash
# å®‰è£…htop
sudo apt install htop

# ç›‘æ§èµ„æºä½¿ç”¨
htop
```

### 2. åº”ç”¨ç›‘æ§
- ä½¿ç”¨ **Sentry** è¿›è¡Œé”™è¯¯è¿½è¸ª
- ä½¿ç”¨ **Prometheus + Grafana** è¿›è¡Œæ€§èƒ½ç›‘æ§

### 3. æ—¥å¿—åˆ†æ
```bash
# å®‰è£…logrotateï¼ˆé€šå¸¸å·²å®‰è£…ï¼‰
sudo apt install logrotate

# é…ç½®æ—¥å¿—è½®è½¬
sudo nano /etc/logrotate.d/inspection
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Pythonç¯å¢ƒå®‰è£…å®Œæˆ
- [ ] PostgreSQLå®‰è£…å¹¶é…ç½®å®Œæˆ
- [ ] é¡¹ç›®æ–‡ä»¶ä¸Šä¼ å®Œæˆ
- [ ] è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå¹¶å®‰è£…ä¾èµ–
- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ
- [ ] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
- [ ] ç™½åå•æ–‡ä»¶ä¸Šä¼ å®Œæˆ
- [ ] Gunicornæµ‹è¯•è¿è¡ŒæˆåŠŸ
- [ ] SystemdæœåŠ¡é…ç½®å®Œæˆ
- [ ] Nginxåå‘ä»£ç†é…ç½®å®Œæˆï¼ˆå¯é€‰ï¼‰
- [ ] é˜²ç«å¢™è§„åˆ™é…ç½®å®Œæˆ
- [ ] SSLè¯ä¹¦é…ç½®å®Œæˆï¼ˆå¯é€‰ï¼‰
- [ ] å¤‡ä»½è„šæœ¬é…ç½®å®Œæˆ
- [ ] æ—¥å¿—è½®è½¬é…ç½®å®Œæˆ

---

## ğŸ” å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **ï¼šæ•°æ®åº“ã€ç®¡ç†å‘˜è´¦æˆ·
2. **ä½¿ç”¨å¼ºå¯†é’¥**ï¼šSECRET_KEYä½¿ç”¨éšæœºç”Ÿæˆçš„é•¿å­—ç¬¦ä¸²
3. **é™åˆ¶è®¿é—®**ï¼šé…ç½®é˜²ç«å¢™ï¼Œåªå¼€æ”¾å¿…è¦ç«¯å£
4. **ä½¿ç”¨HTTPS**ï¼šé…ç½®SSLè¯ä¹¦
5. **å®šæœŸæ›´æ–°**ï¼šç³»ç»Ÿå’Œä¾èµ–åŒ…
6. **å¤‡ä»½æ•°æ®**ï¼šå®šæœŸå¤‡ä»½æ•°æ®åº“å’Œæ–‡ä»¶
7. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥å¼‚å¸¸è®¿é—®

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ—¥å¿—æ–‡ä»¶
2. ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
3. ç½‘ç»œè¿æ¥çŠ¶æ€
4. æ•°æ®åº“è¿æ¥çŠ¶æ€
