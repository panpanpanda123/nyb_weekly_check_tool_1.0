# 服务器快速部署指南

## 当前环境
- 服务器: blitzepanda.top
- 项目目录: `/opt/review-result-viewer`
- 已有Nginx运行中

## 一键部署步骤

### 1. SSH连接服务器
```bash
ssh root@blitzepanda.top
```

### 2. 进入项目目录
```bash
cd /opt/review-result-viewer
```

### 3. 运行一键部署脚本
```bash
bash deploy/server_deploy.sh
```

这个脚本会自动：
- ✅ 安装Python依赖
- ✅ 创建必要的目录
- ✅ 创建systemd服务
- ✅ 启动评级服务
- ✅ 显示Nginx配置示例

### 4. 配置Nginx

#### 方法A：手动编辑（推荐）
```bash
# 1. 备份现有配置
cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup

# 2. 编辑配置文件
nano /etc/nginx/sites-available/default

# 3. 在server块中添加以下内容：
```

```nginx
# 门店评级系统
location /rating {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /api/rating {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

```bash
# 4. 测试配置
nginx -t

# 5. 重载Nginx
systemctl reload nginx
```

#### 方法B：使用脚本自动添加（如果配置简单）
```bash
# 创建配置片段
cat > /etc/nginx/conf.d/rating.conf << 'EOF'
# 门店评级系统配置
location /rating {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /api/rating {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
EOF

# 测试并重载
nginx -t && systemctl reload nginx
```

### 5. 验证部署

```bash
# 检查评级服务状态
systemctl status rating

# 检查Nginx状态
systemctl status nginx

# 测试本地访问
curl http://localhost:8000/rating

# 查看日志
tail -f /opt/review-result-viewer/logs/rating_service.log
```

### 6. 访问系统
浏览器打开: http://blitzepanda.top/rating

## 常用管理命令

### 服务管理
```bash
# 启动服务
systemctl start rating

# 停止服务
systemctl stop rating

# 重启服务
systemctl restart rating

# 查看状态
systemctl status rating

# 查看日志
tail -f /opt/review-result-viewer/logs/rating_service.log
tail -f /opt/review-result-viewer/logs/rating_service_error.log
```

### Nginx管理
```bash
# 测试配置
nginx -t

# 重载配置（不中断服务）
systemctl reload nginx

# 重启Nginx
systemctl restart nginx

# 查看日志
tail -f /var/log/nginx/error.log
tail -f /var/log/nginx/access.log
```

### 数据管理
```bash
# 查看门店数据
cat /opt/review-result-viewer/rating_data/stores.json | python3 -m json.tool | head -20

# 查看评级数据
cat /opt/review-result-viewer/rating_data/ratings.json | python3 -m json.tool

# 备份评级数据
cp /opt/review-result-viewer/rating_data/ratings.json \
   /opt/review-result-viewer/rating_data/ratings.backup.$(date +%Y%m%d).json
```

## 更新代码

### 从本地上传
```bash
# 在本地执行
upload_rating_to_server.bat
```

### 从GitHub拉取
```bash
# 在服务器执行
cd /opt/review-result-viewer
git pull
systemctl restart rating
```

## 故障排查

### 问题1: 服务无法启动
```bash
# 查看详细日志
journalctl -u rating -n 50

# 检查端口占用
netstat -tlnp | grep 8000

# 手动启动测试
cd /opt/review-result-viewer
python3 rating_app.py
```

### 问题2: 502 Bad Gateway
```bash
# 检查服务是否运行
systemctl status rating

# 检查端口
curl http://localhost:8000/rating

# 重启服务
systemctl restart rating
```

### 问题3: 404 Not Found
```bash
# 检查Nginx配置
nginx -t
cat /etc/nginx/sites-available/default | grep -A 10 "location /rating"

# 查看Nginx错误日志
tail -f /var/log/nginx/error.log
```

### 问题4: 数据不更新
```bash
# 检查数据文件
ls -lh /opt/review-result-viewer/rating_data/

# 重启服务
systemctl restart rating
```

## 性能优化

### 使用Gunicorn多进程
已在部署脚本中配置，使用4个worker进程：
```bash
gunicorn -w 4 -b 127.0.0.1:8000 rating_app:app
```

### Nginx缓存（可选）
```nginx
location /static {
    alias /opt/review-result-viewer/viewer/static;
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

## 安全建议

1. **定期备份数据**
```bash
# 添加到crontab
0 2 * * * cp /opt/review-result-viewer/rating_data/ratings.json \
          /opt/review-result-viewer/rating_data/ratings.backup.$(date +\%Y\%m\%d).json
```

2. **监控日志大小**
```bash
# 查看日志大小
du -sh /opt/review-result-viewer/logs/
```

3. **限制访问**（可选）
```nginx
location /rating {
    # 只允许特定IP
    allow 192.168.1.0/24;
    deny all;
    
    proxy_pass http://127.0.0.1:8000;
}
```

## 完整部署流程总结

```bash
# 1. SSH连接
ssh root@blitzepanda.top

# 2. 进入目录
cd /opt/review-result-viewer

# 3. 一键部署
bash deploy/server_deploy.sh

# 4. 配置Nginx（手动编辑）
nano /etc/nginx/sites-available/default
# 添加location /rating 和 /api/rating 配置

# 5. 测试并重载
nginx -t && systemctl reload nginx

# 6. 验证
systemctl status rating
curl http://localhost:8000/rating

# 7. 访问
# http://blitzepanda.top/rating
```

## 联系支持
如有问题，请查看日志文件或联系技术支持。
