# 服务器快速部署指南

## 当前状态

- ✅ 项目位置: `/opt/review-result-viewer`
- ✅ 服务名称: `rating`
- ✅ 监听端口: `8001` ⚠️ 注意：不是8000！
- ✅ 访问地址: `http://blitzepanda.top/rating`

## 快速修复（如果页面无法正常显示）

```bash
# 1. 上传修复后的代码
scp rating_app.py root@blitzepanda.top:/opt/review-result-viewer/

# 2. 上传数据文件（如果缺失）
scp rating_data/stores.json root@blitzepanda.top:/opt/review-result-viewer/rating_data/

# 3. SSH到服务器
ssh root@blitzepanda.top

# 4. 修复Nginx端口配置（如果需要）
sed -i 's|proxy_pass http://127.0.0.1:8000|proxy_pass http://127.0.0.1:8001|g' /etc/nginx/sites-available/default

# 5. 测试并重载Nginx
nginx -t && systemctl reload nginx

# 6. 重启评级服务
systemctl restart rating

# 7. 验证
curl http://127.0.0.1:8001/api/rating/war-zones
```

## 快速命令

### 查看服务状态
```bash
systemctl status rating
```

### 重启服务
```bash
systemctl restart rating
```

### 查看日志
```bash
tail -f /opt/review-result-viewer/logs/rating_app.log
```

### 测试API
```bash
# 本地测试（注意端口是8001）
curl http://127.0.0.1:8001/api/rating/war-zones

# 外网测试
curl http://blitzepanda.top/api/rating/war-zones
```

## Nginx配置

配置文件位置: `/etc/nginx/sites-available/default`

**关键配置（注意端口是8001）**:
```nginx
# 门店评级系统
location /rating {
    proxy_pass http://127.0.0.1:8001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /api/rating {
    proxy_pass http://127.0.0.1:8001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# 静态文件（注意路径末尾的斜杠）
location /static/ {
    alias /opt/review-result-viewer/viewer/static/;
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

### 重载Nginx
```bash
nginx -t && systemctl reload nginx
```

## 更新代码

### 方法1: 直接上传文件（推荐）
```bash
scp rating_app.py root@blitzepanda.top:/opt/review-result-viewer/
ssh root@blitzepanda.top "systemctl restart rating"
```

### 方法2: Git拉取
```bash
ssh root@blitzepanda.top
cd /opt/review-result-viewer
git pull
systemctl restart rating
```

## 上传数据文件

```bash
# 上传门店数据
scp rating_data/stores.json root@blitzepanda.top:/opt/review-result-viewer/rating_data/

# 验证文件大小
ssh root@blitzepanda.top "ls -lh /opt/review-result-viewer/rating_data/stores.json"
```

## 完整部署脚本

如果需要重新部署，运行:
```bash
cd /opt/review-result-viewer
bash deploy/server_deploy.sh
```

## 故障排查

### 问题1: 页面打开但无UI样式
**原因**: 静态文件路径配置错误

**解决**:
```bash
# 检查Nginx配置
grep -A 3 "location /static" /etc/nginx/sites-available/default

# 应该显示:
# location /static/ {
#     alias /opt/review-result-viewer/viewer/static/;
# }

# 测试静态文件
curl -I http://blitzepanda.top/static/rating.js
```

### 问题2: 下拉菜单为空
**原因**: stores.json 文件不存在或为空

**解决**:
```bash
# 检查文件
ssh root@blitzepanda.top "ls -lh /opt/review-result-viewer/rating_data/stores.json"

# 如果文件不存在或太小，重新上传
scp rating_data/stores.json root@blitzepanda.top:/opt/review-result-viewer/rating_data/
```

### 问题3: 服务无法启动
**原因**: 端口被占用或代码错误

**解决**:
```bash
# 查看详细错误
ssh root@blitzepanda.top "journalctl -u rating -n 50"

# 检查端口占用
ssh root@blitzepanda.top "netstat -tlnp | grep 8001"

# 手动运行测试
ssh root@blitzepanda.top
cd /opt/review-result-viewer
python3 rating_app.py
```

### 问题4: 502 Bad Gateway
**原因**: 服务未运行或Nginx端口配置错误

**解决**:
```bash
# 检查服务状态
systemctl status rating

# 检查Nginx配置中的端口
grep "proxy_pass" /etc/nginx/sites-available/default | grep rating

# 应该显示 http://127.0.0.1:8001，如果是8000则需要修改
```

### 问题5: 404 Not Found
**原因**: Nginx配置缺失或路径错误

**解决**:
```bash
# 检查Nginx配置
nginx -t
cat /etc/nginx/sites-available/default | grep -A 5 "location /rating"
```

## 检查清单

部署后按此清单验证：

- [ ] 服务运行正常: `systemctl status rating`
- [ ] 端口监听正确: `netstat -tlnp | grep 8001`
- [ ] 数据文件存在: `ls -lh rating_data/stores.json`
- [ ] API响应正常: `curl http://127.0.0.1:8001/api/rating/war-zones`
- [ ] 静态文件可访问: `curl -I http://blitzepanda.top/static/rating.js`
- [ ] 页面可以打开: 浏览器访问 `http://blitzepanda.top/rating`
- [ ] 筛选功能正常: 下拉菜单有选项
- [ ] 评级功能正常: 可以提交评级

## 备份评级数据

```bash
# 下载评级结果
scp root@blitzepanda.top:/opt/review-result-viewer/rating_data/ratings.json ./backup/

# 或在服务器上备份
ssh root@blitzepanda.top
cp /opt/review-result-viewer/rating_data/ratings.json \
   /opt/review-result-viewer/rating_data/ratings.backup.$(date +%Y%m%d).json
```

## 详细部署指南

如需更详细的说明，请查看:
- `deploy/rating_deploy_guide.md` - 完整部署和故障排查指南
- `deploy/nginx_config_guide.md` - Nginx配置详解
