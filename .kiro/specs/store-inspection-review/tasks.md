# 实施计划

- [x] 1. 设置项目结构和依赖
  - 创建项目目录结构（app.py, templates/, static/, tests/）
  - 创建requirements.txt文件，包含Flask、pandas、openpyxl、pytest
  - 创建基本的Flask应用骨架
  - _需求: 1.1, 1.2_

- [x] 2. 实现数据加载模块
  - 编写DataLoader类，实现Excel文件读取功能
  - 实现数据验证逻辑，检查必需字段是否存在
  - 实现数据转换功能，将DataFrame转换为字典列表
  - 为每个检查项生成唯一ID（门店编号_检查项名称）
  - _需求: 2.1, 2.2, 2.5_

- [x] 2.5 实现白名单加载模块
  - 编写WhitelistLoader类，读取白名单Excel文件
  - 实现load_whitelist方法，读取白名单数据
  - 实现get_operator_mapping方法，生成门店ID到运营人员的映射
  - 实现运营人员分配逻辑（优先临时运营，其次省市运营）
  - 处理白名单文件不存在的情况（显示警告但继续运行）
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [x] 2.6 关联检查项数据与运营人员
  - 在DataLoader中集成WhitelistLoader
  - 为每个检查项添加"负责运营"字段
  - 通过门店编号匹配白名单中的门店ID
  - 处理匹配不到的情况（显示"未分配"）
  - _需求: 8.3, 8.4, 8.5_

- [x] 3. 实现审核数据管理器
  - 编写ReviewManager类，使用字典存储审核结果
  - 实现save_review方法，保存新的审核结果
  - 实现update_review方法，更新现有审核结果
  - 实现get_review和get_all_reviews方法
  - 添加时间戳生成功能
  - _需求: 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3_

- [x] 4. 实现CSV导出器
  - 编写CSVExporter类
  - 实现export_reviews方法，合并原始数据和审核结果
  - 实现generate_csv_content方法，生成CSV格式字符串
  - 确保使用UTF-8编码（添加BOM以支持Excel正确打开）
  - _需求: 6.1, 6.2, 6.5_

- [x] 5. 实现Flask API端点
  - 实现GET / 端点，返回主页面HTML
  - 实现GET /api/items 端点，返回所有检查项数据（按门店编号排序，支持运营人员筛选）
  - 实现GET /api/operators 端点，返回所有运营人员列表
  - 实现POST /api/review 端点，接收审核结果
  - 实现GET /api/reviews 端点，返回所有审核结果
  - 添加错误处理和适当的HTTP状态码
  - _需求: 1.3, 3.1, 3.2, 3.5, 4.2, 4.3, 5.1, 9.2_

- [x] 5.1 集成CSV导出到API端点
  - 在app.py中导入CSVExporter
  - 实现GET /api/export端点，调用CSVExporter生成CSV
  - 设置正确的响应头（Content-Type和Content-Disposition）
  - 处理无审核结果的情况
  - _需求: 6.1, 6.3, 6.4_

- [x] 6. 实现前端HTML页面
  - 创建index.html模板，包含基本页面结构
  - 实现检查项卡片布局，显示门店信息和检查项名称
  - 添加运营人员筛选下拉框
  - 添加图片显示区域，使用<img>标签
  - 添加合格（✓）和不合格（✗）按钮
  - 实现响应式CSS样式
  - _需求: 3.2, 3.3, 4.1, 7.1, 7.2, 9.1, 9.6_

- [x] 7. 实现前端JavaScript交互逻辑
  - 实现页面加载时获取检查项数据的功能
  - 实现获取运营人员列表的功能
  - 实现运营人员筛选功能
  - 实现动态渲染检查项卡片的功能（包含运营人员信息）
  - 实现审核按钮点击事件处理
  - 实现审核结果提交到后端API
  - 实现审核状态的视觉反馈（按钮高亮、颜色变化）
  - 实现图片加载错误处理（显示占位符）
  - _需求: 3.3, 4.2, 4.3, 4.4, 7.5, 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 8. 实现前端CSV导出功能
  - 在前端添加导出按钮
  - 实现导出按钮点击事件，调用/api/export端点
  - 实现文件下载处理
  - 添加导出状态提示（成功/失败/无数据）
  - _需求: 6.1, 6.3, 6.4_

- [x] 9. 实现服务器启动和配置
  - 配置Flask应用在局域网可访问（host='0.0.0.0'）
  - 实现启动时显示局域网IP地址和端口号
  - 添加启动日志和错误日志
  - _需求: 1.1, 1.2_

- [x] 10. 添加错误处理和边缘情况
  - 实现Excel文件不存在时的错误处理
  - 实现Excel文件格式错误时的错误处理
  - 实现API请求错误时的前端提示
  - 实现图片加载失败时的占位符显示
  - _需求: 2.3, 2.4, 3.4_

- [x] 11. 修改为固定文件名模式
  - 修改app.py使用固定文件名"检查项记录.xlsx"
  - 更新数据加载逻辑以支持固定文件名
  - _需求: 数据源管理_

- [x] 12. 创建一键启动脚本
  - 创建桌面启动脚本（启动审核系统.bat）
  - 实现文件选择对话框，选择Excel文件
  - 自动将选中文件复制为"检查项记录.xlsx"
  - 清理旧的数据文件
  - 启动Flask应用
  - _需求: 数据源管理_

- [x] 13. 实现管理员面板（前端）
  - 在前端添加管理员面板（仅当筛选"窦"时显示）
  - 显示审核进度统计（已审核/总数，百分比）
  - 添加"完成本周"按钮（触发CSV导出）
  - 添加"开始新周期"按钮（重置审核数据）
  - 实现管理员面板的CSS样式
  - _需求: 周期管理_

- [x] 14. 实现管理员API端点
  - 实现POST /api/admin/reset端点，清空审核记录并重新加载数据
  - 实现GET /api/stats端点，返回审核统计信息（总数、已审核数、百分比）
  - 添加简单的权限验证（检查operator参数是否为"窦"）
  - _需求: 周期管理_

- [ ] 15. 最终测试
  - 测试完整工作流：选择文件 → 启动 → 审核 → 管理员操作
  - 验证CSV导出功能
  - 验证数据重置功能
  - 确保所有功能正常运行
