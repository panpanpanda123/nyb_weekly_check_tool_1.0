# 数据更新操作指南

## 📋 当前系统配置

### 1. 本地周清审核系统
- **whitelist路径**：`D:/pythonproject/Newyobo_operat_database/daily_data/whitelist/whitelist.xlsx`
- **状态**：✅ 已配置为你想要的路径
- **自动更新**：每天自动更新
- **用途**：匹配门店的运营人员（临时运营 > 省市运营）

### 2. 云服务器反馈检查系统
- **数据存储**：PostgreSQL数据库
- **whitelist表**：`StoreWhitelist`
- **审核结果表**：`ViewerReviewResult`
- **访问地址**：http://blitzepanda.top/weeklycheck

---

## 🔄 完整数据更新流程

### 步骤1：本地审核（你已完成）
```
1. 双击"启动周清审核.bat"
2. 系统自动加载最新的whitelist.xlsx
3. 上传"检查项记录.xlsx"
4. 进行审核
5. 导出审核结果CSV
```

### 步骤2：上传到云服务器

#### 方法A：通过Web界面（推荐）

1. **访问管理页面**
   ```
   http://blitzepanda.top/weeklycheck/admin/upload
   ```

2. **上传whitelist（重新匹配运营人员）**
   - 点击"上传白名单"
   - 选择：`D:/pythonproject/Newyobo_operat_database/daily_data/whitelist/whitelist.xlsx`
   - 上传成功后，系统会清空旧数据并导入新的门店信息

3. **上传审核结果**
   - 点击"上传审核结果"
   - 选择导出的CSV文件（例如：`审核结果_20260205.csv`）
   - 系统会自动匹配whitelist中的门店信息
   - 如果门店在whitelist中找不到，会标记为"[未匹配]"

#### 方法B：使用命令行（高级）

```bash
# SSH到服务器
ssh root@blitzepanda.top

# 进入项目目录
cd /opt/review-result-viewer

# 运行数据导入脚本（如果有的话）
python import_data.py --whitelist /path/to/whitelist.xlsx --reviews /path/to/reviews.csv
```

---

## ⚠️ 关于"未分配"门店的问题

### 问题原因
某些门店在whitelist.xlsx中：
- 没有"临时运营"字段
- 没有"省市运营"字段
- 导致系统无法分配运营人员

### 解决方案

#### 方案1：更新whitelist后重新审核（推荐）

```
1. 确保whitelist.xlsx已更新（包含所有门店的运营信息）
2. 重新启动本地审核系统
3. 重新审核那些"未分配"的门店
4. 导出新的审核结果
5. 上传到云服务器
```

#### 方案2：在云服务器上重新匹配

```
1. 上传最新的whitelist.xlsx到云服务器
2. 重新上传审核结果CSV
3. 系统会自动重新匹配运营人员
```

---

## 📊 数据匹配逻辑

### 本地系统（app.py）
```python
# 优先级：临时运营 > 省市运营 > "未分配"
if '临时运营' 有值:
    使用临时运营
elif '省市运营' 有值:
    使用省市运营
else:
    显示"未分配"
```

### 云服务器（viewer/data_importer.py）
```python
# 导入审核结果时：
1. 从whitelist表中查找门店ID
2. 如果找到：补充战区、省份、城市信息
3. 如果找不到：标记为"[未匹配]"
```

---

## 🎯 推荐操作流程

### 情况1：whitelist已更新，需要重新审核

```
1. 确认whitelist.xlsx已更新
2. 启动本地审核系统（会自动加载最新whitelist）
3. 重新审核"未分配"的门店
4. 导出新的审核结果
5. 访问 http://blitzepanda.top/weeklycheck/admin/upload
6. 先上传whitelist.xlsx
7. 再上传审核结果CSV
```

### 情况2：whitelist未更新，但已完成审核

```
1. 先更新whitelist.xlsx（添加缺失的运营人员信息）
2. 访问 http://blitzepanda.top/weeklycheck/admin/upload
3. 上传更新后的whitelist.xlsx
4. 重新上传审核结果CSV（系统会自动重新匹配）
```

### 情况3：只想更新云服务器的whitelist

```
1. 访问 http://blitzepanda.top/weeklycheck/admin/upload
2. 只上传whitelist.xlsx
3. 不需要重新上传审核结果
4. 下次上传审核结果时会使用新的whitelist
```

---

## 📁 文件说明

### whitelist.xlsx 必需列
- 门店ID（或门店编号）
- 门店名称
- 战区
- 省份
- 城市
- 临时运营（可选）
- 省市运营（可选）
- 区域经理（可选）

### 审核结果CSV 必需列
- 门店名称
- 门店编号
- 检查项名称
- 审核结果
- 审核时间（可选）
- 问题描述（可选）

---

## 🔍 验证数据是否正确

### 1. 检查本地whitelist
```bash
# 打开Excel查看
D:/pythonproject/Newyobo_operat_database/daily_data/whitelist/whitelist.xlsx

# 确认以下列有数据：
- 门店ID
- 临时运营 或 省市运营
```

### 2. 检查云服务器数据
```
1. 访问：http://blitzepanda.top/weeklycheck
2. 查看筛选选项中的战区、省份、城市是否正确
3. 查看门店是否有"[未匹配]"标记
```

### 3. 检查审核结果
```
1. 访问：http://blitzepanda.top/weeklycheck
2. 筛选查看各个战区的数据
3. 确认门店信息完整
```

---

## 🚨 常见问题

### Q1: 上传whitelist后，之前的审核结果会丢失吗？
A: 不会。whitelist和审核结果是分开存储的。

### Q2: 重新上传审核结果会覆盖之前的数据吗？
A: 会。系统会清空旧的审核结果，导入新的数据。

### Q3: 如果门店在whitelist中找不到怎么办？
A: 系统会标记为"[未匹配]"，但不会影响审核结果的显示。

### Q4: 本地系统的whitelist路径可以修改吗？
A: 可以，但不需要。当前已经配置为你想要的路径：
   `D:/pythonproject/Newyobo_operat_database/daily_data/whitelist/whitelist.xlsx`

### Q5: 如何确认whitelist是否自动更新？
A: 查看文件的修改时间：
   ```bash
   # 在文件资源管理器中右键 → 属性 → 查看"修改日期"
   ```

---

## 📝 操作检查清单

### 本地审核前
- [ ] 确认whitelist.xlsx已更新（查看修改日期）
- [ ] 确认"检查项记录.xlsx"已准备好
- [ ] 启动"启动周清审核.bat"

### 上传到云服务器前
- [ ] 已完成本地审核
- [ ] 已导出审核结果CSV
- [ ] 确认whitelist.xlsx是最新版本

### 上传到云服务器
- [ ] 访问 http://blitzepanda.top/weeklycheck/admin/upload
- [ ] 先上传whitelist.xlsx
- [ ] 等待上传成功提示
- [ ] 再上传审核结果CSV
- [ ] 等待上传成功提示

### 验证数据
- [ ] 访问 http://blitzepanda.top/weeklycheck
- [ ] 检查筛选选项是否正常
- [ ] 检查门店数据是否完整
- [ ] 检查是否有"[未匹配]"标记

---

## 💡 最佳实践

1. **每次审核前**：确认whitelist.xlsx是最新的
2. **审核完成后**：立即导出CSV并上传到云服务器
3. **定期备份**：保存每次的审核结果CSV
4. **遇到问题**：先上传最新的whitelist.xlsx，再重新上传审核结果

---

## 📞 需要帮助？

如果遇到问题：
1. 检查whitelist.xlsx的列名是否正确
2. 检查门店ID是否匹配
3. 查看云服务器日志：`ssh root@blitzepanda.top "tail -50 /opt/review-result-viewer/logs/app.log"`
