# 门店检查项图片审核系统 - 完整使用文档

## 📋 目录
- [快速开始](#快速开始)
- [系统安装](#系统安装)
- [日常使用](#日常使用)
- [管理员功能](#管理员功能)
- [常见问题](#常见问题)
- [技术说明](#技术说明)

---

## 🚀 快速开始

### 启动系统
1. 双击 `启动周清图片检查系统.bat`
2. 等待系统启动（约5-10秒）
3. 浏览器访问显示的地址（如：http://192.168.110.124:5001）

### 首次使用
1. 选择"窦"（管理员）
2. 点击"📤 上传新Excel"导入数据
3. 开始审核！

---

## 💻 系统安装

### 第一步：安装PostgreSQL数据库

1. 下载PostgreSQL：https://www.postgresql.org/download/windows/
2. 安装时记住设置的密码（默认用户名：postgres）
3. 确保PostgreSQL服务正在运行

### 第二步：创建数据库

打开命令行（CMD），执行：
```bash
psql -U postgres
# 输入密码后
CREATE DATABASE configurable_ops;
\q
```

### 第三步：安装Python依赖

在项目目录打开命令行：
```bash
pip install -r requirements.txt
```

如果安装慢，使用国内镜像：
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 第四步：初始化数据库表

```bash
python init_database.py
```

看到"✓ 数据库初始化完成！"就成功了。

### 第五步：启动系统

双击 `启动周清图片检查系统.bat` 或命令行执行：
```bash
python app.py
```

---

## 📱 日常使用

### 1. 查看检查项
- 系统自动加载所有检查项
- 每个卡片显示门店信息和现场图片
- 页面顶部显示总计和已审核数量

### 2. 进行审核
- 查看每个检查项的现场图片
- 点击"✓ 合格"或"✗ 不合格"按钮
- 选择"不合格"后输入问题描述
- **按回车键**或点击"✓ 保存并完成"按钮确认
- 审核结果自动保存到数据库

### 3. 查看大图
- 🔍 点击任意图片可放大查看高清大图
- 点击背景或按ESC键关闭

### 4. 已完成列表
- 切换到"已完成列表"标签
- 查看已完成的门店
- 点击门店卡片展开详情
- 可以重新编辑审核结果

### 5. 运营人员筛选
- 选择自己的名字进行筛选
- 只显示自己负责的门店

---

## 👨‍💼 管理员功能（仅"窦"）

选择"窦"后会看到管理员工具面板：

### 1. ✓ 完成本周并导出
- 点击后自动下载CSV文件
- 文件名格式：`审核结果_2026-01-10.csv`
- 需要至少有一条审核结果才能导出

### 2. 📤 上传新Excel（开始新周期）
- 点击选择新的Excel文件
- 上传后自动清空数据库中的审核记录
- 系统重新加载新数据

### 3. 查看统计信息
- 显示完成进度（按门店统计）
- 显示完成百分比

---

## ❓ 常见问题

### Q: 启动时提示"数据库连接失败"？
**A:** 请确保PostgreSQL正在运行，并且数据库 `configurable_ops` 已创建。

### Q: 点击导出提示"暂无审核结果"？
**A:** 需要先审核至少一个检查项才能导出。

### Q: 如何开始新一周的审核？
**A:** 选择"窦"，点击"📤 上传新Excel"，选择新的Excel文件即可。

### Q: 如何修改已完成的审核？
**A:** 切换到"已完成列表"标签，点击门店卡片展开，可以重新编辑。

### Q: 为什么有些检查项已经标记为不合格？
**A:** 这些是无现场结果的检查项，系统自动标记为不合格，问题描述为"无现场结果"。

### Q: 关闭程序后审核数据会丢失吗？
**A:** 不会！审核数据保存在数据库中，可以持续多天工作。

### Q: 输入问题描述后如何确认？
**A:** 按**回车键**或点击"✓ 保存并完成"按钮，输入框会自动收起。

### Q: 如何修改已输入的问题描述？
**A:** 再次点击"✗ 不合格"按钮，输入框会重新打开，可以修改内容。

### Q: 图片显示"加载失败"？
**A:** 
- 检查网络连接
- 图片可能正在加载中，等待几秒
- 点击"🔄 重新加载"按钮重试

### Q: 端口被占用怎么办？
**A:** 修改 `app.py` 中的 `port = 5001` 为其他端口（如5002、8000等）。

### Q: 局域网其他设备无法访问？
**A:**
- 确认所有设备在同一WiFi/局域网
- 检查Windows防火墙是否阻止端口
- 尝试临时关闭防火墙测试

---

## 🔧 技术说明

### 系统架构
- **前端**：HTML + CSS + JavaScript
- **后端**：Python Flask
- **数据库**：PostgreSQL
- **图片存储**：外部图床（Coolstore、阿里云OSS）

### 数据存储方式
1. **Excel数据**：上传后全部加载到内存（快速访问）
2. **白名单数据**：启动时自动加载到数据库（持久化）
3. **审核记录**：保存在PostgreSQL数据库（持久化存储）

### 图片显示方式
- 直接从图床加载（不经过后端转发）
- 支持懒加载（`loading="lazy"`）
- 支持防盗链绕过（`referrerpolicy="no-referrer"`）
- 自动重试机制（失败后自动重试3次）

### 统计逻辑
- 按**门店**统计（不是按检查项数）
- 只有门店所有检查项都审核完才算完成
- 不合格的检查项必须填写问题描述才算完成

### Excel文件格式要求
- **必需列**：检查项名称、门店名称、门店编号、所属区域、现场结果
- **图片链接**：只从"现场结果"列获取（JSON数组格式，如 `["https://..."]`）
- **支持的图片格式**：
  - Coolstore图床：`https://ossfile1.coolstore.cn/...`
  - 阿里云OSS：`https://store-ossfile-1.oss-cn-hangzhou.aliyuncs.com/...`

### 数据库配置
默认连接：`postgresql://postgres:postgres@127.0.0.1:5432/configurable_ops`

如需修改，设置环境变量：
```bash
set DATABASE_URL=postgresql://用户名:密码@主机:端口/数据库名
```

### 端口配置
默认端口：**5001**

推荐端口：5002、8000、8080、8888、9000

修改方法：编辑 `app.py` 中的 `port = 5001`

---

## ✨ 系统特性

- ✅ 数据库持久化存储（PostgreSQL）
- ✅ 白名单自动加载到数据库
- ✅ 按门店统计完成率
- ✅ 自动审核无现场结果项（约20%工作量）
- ✅ 已完成列表可编辑
- ✅ 回车键快速确认
- ✅ 按钮状态清晰可见
- ✅ 线程安全（支持多用户并发）
- ✅ 空启动支持（无需Excel文件）
- ✅ 图片点击放大查看（支持高清大图）
- ✅ 图片自动重试机制（网络不稳定时）
- ✅ 懒加载优化（提升加载速度）

---

## 📞 获取帮助

如果遇到问题：
1. 查看本文档的常见问题部分
2. 查看启动窗口的错误信息
3. 检查数据库连接状态

---

**祝使用愉快！** 🎉
