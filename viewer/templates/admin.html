<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ç®¡ç† - å®¡æ ¸ç»“æœå±•ç¤ºç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='viewer.css') }}">
    <style>
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .upload-section h2 {
            font-size: 22px;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-section p {
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #e8eaf6;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 16px;
            color: #34495e;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 13px;
            color: #95a5a6;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        .upload-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .result-message.success {
            background-color: #d5f4e6;
            color: #27ae60;
            border-left: 4px solid #27ae60;
        }
        
        .result-message.error {
            background-color: #fadbd8;
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
        }
        
        .result-message.info {
            background-color: #d6eaf8;
            color: #2980b9;
            border-left: 4px solid #2980b9;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            opacity: 0.8;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <a href="/" class="back-link">â† è¿”å›å±•ç¤ºç³»ç»Ÿ</a>
        
        <header style="background-color: #fff; padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-bottom: 30px;">
            <h1 style="font-size: 28px; color: #2c3e50; margin: 0;">ğŸ”§ æ•°æ®ç®¡ç†</h1>
        </header>
        
        <!-- ç™½åå•ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <h2>ğŸ“‹ ä¸Šä¼ ç™½åå•</h2>
            <p>ä¸Šä¼ åŒ…å«é—¨åº—åŸºç¡€ä¿¡æ¯çš„Excelæ–‡ä»¶ï¼ˆ.xlsxæ ¼å¼ï¼‰ï¼ŒåŒ…å«æˆ˜åŒºã€çœä»½ã€åŸå¸‚ã€é—¨åº—æ ‡ç­¾ç­‰å­—æ®µã€‚</p>
            
            <div class="upload-area" id="whitelistUploadArea" onclick="document.getElementById('whitelistFile').click()">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒ .xlsx æ ¼å¼ï¼Œæœ€å¤§ 50MB</div>
            </div>
            
            <input type="file" id="whitelistFile" class="file-input" accept=".xlsx">
            <button id="whitelistUploadBtn" class="upload-btn" disabled>ä¸Šä¼ ç™½åå•</button>
            
            <div class="progress-bar" id="whitelistProgress">
                <div class="progress-fill"></div>
            </div>
            
            <div class="result-message" id="whitelistResult"></div>
        </div>
        
        <!-- å®¡æ ¸ç»“æœä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <h2>ğŸ“Š ä¸Šä¼ å®¡æ ¸ç»“æœ</h2>
            <p>ä¸Šä¼ å®¡æ ¸ç³»ç»Ÿå¯¼å‡ºçš„å®¡æ ¸ç»“æœCSVæ–‡ä»¶ï¼ˆ.csvæ ¼å¼ï¼‰ï¼ŒåŒ…å«é—¨åº—å®¡æ ¸æ•°æ®ã€‚</p>
            
            <div class="upload-area" id="reviewsUploadArea" onclick="document.getElementById('reviewsFile').click()">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒ .csv æ ¼å¼ï¼Œæœ€å¤§ 50MB</div>
            </div>
            
            <input type="file" id="reviewsFile" class="file-input" accept=".csv">
            <button id="reviewsUploadBtn" class="upload-btn" disabled>ä¸Šä¼ å®¡æ ¸ç»“æœ</button>
            
            <div class="progress-bar" id="reviewsProgress">
                <div class="progress-fill"></div>
            </div>
            
            <div class="result-message" id="reviewsResult"></div>
        </div>
    </div>
    
    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>
    
    <script>
        // ç™½åå•æ–‡ä»¶ä¸Šä¼ 
        const whitelistFile = document.getElementById('whitelistFile');
        const whitelistUploadBtn = document.getElementById('whitelistUploadBtn');
        const whitelistUploadArea = document.getElementById('whitelistUploadArea');
        const whitelistResult = document.getElementById('whitelistResult');
        const whitelistProgress = document.getElementById('whitelistProgress');
        
        // å®¡æ ¸ç»“æœæ–‡ä»¶ä¸Šä¼ 
        const reviewsFile = document.getElementById('reviewsFile');
        const reviewsUploadBtn = document.getElementById('reviewsUploadBtn');
        const reviewsUploadArea = document.getElementById('reviewsUploadArea');
        const reviewsResult = document.getElementById('reviewsResult');
        const reviewsProgress = document.getElementById('reviewsProgress');
        
        // ç™½åå•æ–‡ä»¶é€‰æ‹©
        whitelistFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                whitelistUploadArea.querySelector('.upload-text').textContent = `å·²é€‰æ‹©: ${file.name}`;
                whitelistUploadBtn.disabled = false;
            }
        });
        
        // å®¡æ ¸ç»“æœæ–‡ä»¶é€‰æ‹©
        reviewsFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                reviewsUploadArea.querySelector('.upload-text').textContent = `å·²é€‰æ‹©: ${file.name}`;
                reviewsUploadBtn.disabled = false;
            }
        });
        
        // ç™½åå•ä¸Šä¼ 
        whitelistUploadBtn.addEventListener('click', async function() {
            await uploadFile(whitelistFile.files[0], '/api/upload/whitelist', whitelistResult, whitelistProgress, whitelistUploadBtn);
        });
        
        // å®¡æ ¸ç»“æœä¸Šä¼ 
        reviewsUploadBtn.addEventListener('click', async function() {
            await uploadFile(reviewsFile.files[0], '/api/upload/reviews', reviewsResult, reviewsProgress, reviewsUploadBtn);
        });
        
        // æ‹–æ‹½ä¸Šä¼  - ç™½åå•
        setupDragAndDrop(whitelistUploadArea, whitelistFile);
        
        // æ‹–æ‹½ä¸Šä¼  - å®¡æ ¸ç»“æœ
        setupDragAndDrop(reviewsUploadArea, reviewsFile);
        
        /**
         * è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
         */
        function setupDragAndDrop(uploadArea, fileInput) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }
        
        /**
         * ä¸Šä¼ æ–‡ä»¶
         */
        async function uploadFile(file, url, resultDiv, progressDiv, uploadBtn) {
            if (!file) {
                showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }
            
            try {
                // æ˜¾ç¤ºè¿›åº¦æ¡
                progressDiv.style.display = 'block';
                progressDiv.querySelector('.progress-fill').style.width = '30%';
                
                // ç¦ç”¨ä¸Šä¼ æŒ‰é’®
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                progressDiv.querySelector('.progress-fill').style.width = '70%';
                
                const data = await response.json();
                
                progressDiv.querySelector('.progress-fill').style.width = '100%';
                
                // éšè—è¿›åº¦æ¡
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressDiv.querySelector('.progress-fill').style.width = '0%';
                }, 500);
                
                // æ˜¾ç¤ºç»“æœ
                if (data.success) {
                    showResult(resultDiv, data.message, 'success');
                    showToast('ä¸Šä¼ æˆåŠŸ', 'success');
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    file.value = '';
                    uploadBtn.textContent = url.includes('whitelist') ? 'ä¸Šä¼ ç™½åå•' : 'ä¸Šä¼ å®¡æ ¸ç»“æœ';
                } else {
                    showResult(resultDiv, data.error, 'error');
                    showToast('ä¸Šä¼ å¤±è´¥', 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = url.includes('whitelist') ? 'ä¸Šä¼ ç™½åå•' : 'ä¸Šä¼ å®¡æ ¸ç»“æœ';
                }
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showResult(resultDiv, 'ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                showToast('ä¸Šä¼ å¤±è´¥', 'error');
                
                // éšè—è¿›åº¦æ¡
                progressDiv.style.display = 'none';
                progressDiv.querySelector('.progress-fill').style.width = '0%';
                
                uploadBtn.disabled = false;
                uploadBtn.textContent = url.includes('whitelist') ? 'ä¸Šä¼ ç™½åå•' : 'ä¸Šä¼ å®¡æ ¸ç»“æœ';
            }
        }
        
        /**
         * æ˜¾ç¤ºç»“æœæ¶ˆæ¯
         */
        function showResult(resultDiv, message, type) {
            resultDiv.textContent = message;
            resultDiv.className = `result-message ${type}`;
            resultDiv.style.display = 'block';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }
        
        /**
         * æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
