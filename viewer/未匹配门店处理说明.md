# 未匹配门店处理说明

## 功能概述

当导入审核结果CSV文件时，系统会自动检查每个门店是否在白名单中存在。对于白名单中找不到的门店，系统会将其标记为"[未匹配]"，方便管理员识别和手动处理。

## 工作原理

### 1. 数据导入逻辑

在导入审核结果CSV时，系统会：

1. **优先使用CSV中的地理信息**
   - 如果CSV文件中已包含战区、省份、城市信息，直接使用这些信息
   
2. **从白名单补充缺失信息**
   - 如果CSV中缺少地理信息，系统会根据门店ID从白名单中查找
   - 如果找到匹配的门店，使用白名单中的战区、省份、城市信息
   
3. **标记未匹配门店**
   - 如果门店在白名单中不存在，且CSV中也没有提供地理信息
   - 系统会将战区、省份、城市字段标记为 `[未匹配]`

### 2. 导入结果反馈

导入完成后，系统会显示：
- 总导入记录数
- 未匹配门店数量
- 示例消息：`审核结果导入成功，共导入 100 条记录，其中 5 个门店在白名单中未找到（已标记为"[未匹配]"）`

## API接口

### 查询未匹配门店

**接口**: `GET /api/unmatched-stores`

**返回示例**:
```json
{
  "success": true,
  "data": {
    "stores": [
      {
        "store_id": "1003",
        "store_name": "测试门店C",
        "war_zone": "[未匹配]",
        "province": "[未匹配]",
        "city": "[未匹配]",
        "items_count": 3,
        "items": [
          {
            "item_name": "卫生检查",
            "review_result": "合格",
            "review_time": "2026-01-15 10:00:00"
          }
        ]
      }
    ],
    "total_stores": 5,
    "total_items": 15
  }
}
```

### 筛选功能

在筛选下拉菜单中，`[未匹配]` 会作为一个选项出现，可以专门筛选出所有未匹配的门店。

## 使用场景

### 场景1：新开门店
- 新开的门店可能还没有加入白名单
- 审核结果会被标记为 `[未匹配]`
- 管理员可以查看这些门店，然后更新白名单

### 场景2：门店ID错误
- 如果审核时填写了错误的门店ID
- 系统会标记为 `[未匹配]`
- 管理员可以核对并修正

### 场景3：已关闭门店
- 已关闭的门店可能已从白名单移除
- 但历史审核记录仍会保留
- 标记为 `[未匹配]` 便于识别

## 手动处理流程

1. **查看未匹配门店列表**
   - 访问 `/api/unmatched-stores` 接口
   - 或在前端界面筛选 `[未匹配]` 选项

2. **核对门店信息**
   - 检查门店ID是否正确
   - 确认门店是否应该在白名单中

3. **更新白名单**
   - 如果是新门店，添加到白名单Excel
   - 重新上传白名单文件

4. **重新导入审核结果**
   - 上传最新的白名单后
   - 重新导入审核结果CSV
   - 系统会自动匹配并更新地理信息

## 注意事项

1. **CSV优先级**
   - 如果CSV中已包含战区/省份/城市信息，系统会优先使用CSV的数据
   - 即使门店在白名单中，也会使用CSV中的信息

2. **标记不影响功能**
   - 标记为 `[未匹配]` 的门店仍然可以正常显示和筛选
   - 不会影响其他功能的使用

3. **批量处理**
   - 建议定期检查未匹配门店列表
   - 集中处理，避免数据不一致

## 测试验证

系统包含完整的测试用例：
- `tests/test_unmatched_stores.py` - 未匹配门店功能测试
- 验证标记逻辑正确性
- 验证API返回数据准确性
