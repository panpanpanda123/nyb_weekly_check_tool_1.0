# 门店评级系统说明

## 系统概述

门店评级系统是一个独立的Web应用，用于区域经理对门店进行A/B/C评级。系统特点：

- ✅ 独立运行，无需数据库
- ✅ 使用JSON文件存储数据
- ✅ 支持筛选（战区、区域经理）
- ✅ 每页显示5家门店
- ✅ 移动端响应式设计
- ✅ 自动保存评级
- ✅ CSV导出功能
- ✅ 完成率统计

## 本地使用

### 1. 导出门店数据
```bash
python export_stores_to_json.py
```
这会从数据库导出门店数据到 `rating_data/stores.json`

### 2. 启动应用
```bash
python rating_app.py
```

### 3. 访问系统
打开浏览器访问: http://localhost:8000/rating

## 云服务器部署

### 快速部署

1. **上传文件到服务器**
```bash
upload_rating_to_server.bat
```

2. **SSH连接服务器**
```bash
ssh root@blitzepanda.top
cd /root/rating
```

3. **运行部署脚本**
```bash
bash deploy_rating.sh
```

4. **启动服务**
```bash
systemctl start rating
systemctl status rating
```

5. **配置Nginx**

编辑Nginx配置文件，添加：
```nginx
location /rating {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location /api/rating {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

重启Nginx：
```bash
nginx -t
systemctl reload nginx
```

6. **访问系统**
http://blitzepanda.top/rating

## 评价标准

- **A类门店**：装修、客流量、服务意识、配合度、堂食营业额都优秀
- **B类门店**：装修、服务意识、配合度良好，堂食营业额有较高提升空间
- **C类门店**：某方面存在硬伤，较难提升

## 使用流程

1. 打开评级页面
2. 选择战区（可选）
3. 选择区域经理（可选）
4. 点击"搜索"查看门店列表
5. 查看门店信息和堂食营业额
6. 根据评价标准点击A/B/C按钮评级
7. 评级自动保存
8. 当前页5家门店全部评级完成后，自动提示翻页
9. 完成所有评级后，点击"导出CSV"下载结果

## 数据文件说明

### stores.json
门店基础数据，包含：
- store_id: 门店ID
- store_name: 门店名称
- city: 城市
- war_zone: 战区
- regional_manager: 区域经理
- dine_in_revenue: 堂食营业额

### ratings.json
评级数据，格式：
```json
{
  "门店ID": {
    "rating": "A",
    "updated_at": "2026-02-04T12:00:00"
  }
}
```

## 更新门店数据

如果需要更新门店数据：

1. 更新本地数据库中的门店信息
2. 运行导出脚本：`python export_stores_to_json.py`
3. 上传新的 `stores.json` 到服务器
4. 重启服务：`systemctl restart rating`

## 备份评级数据

定期备份服务器上的 `rating_data/ratings.json` 文件：
```bash
scp root@blitzepanda.top:/root/rating/rating_data/ratings.json ./backup/
```

## 查看日志

应用日志：
```bash
ssh root@blitzepanda.top
tail -f /root/rating/logs/rating_app.log
```

服务日志：
```bash
journalctl -u rating -f
```

## 常见问题

### Q: 页面显示404错误
A: 检查Nginx配置是否正确，确保proxy_pass指向8000端口

### Q: 评级无法保存
A: 检查 `rating_data` 目录权限，确保应用有写入权限

### Q: 门店数据未更新
A: 重新运行 `export_stores_to_json.py` 并上传新文件到服务器

### Q: 如何重置所有评级
A: 删除服务器上的 `rating_data/ratings.json` 文件，系统会自动创建新文件

## 技术栈

- **后端**: Flask (Python)
- **前端**: 原生JavaScript + CSS
- **数据存储**: JSON文件
- **部署**: Gunicorn + Nginx + Systemd

## 文件结构

```
rating_app.py                    # 主应用
export_stores_to_json.py         # 数据导出脚本
upload_rating_to_server.bat      # 上传脚本
rating_data/
  ├── stores.json                # 门店数据
  └── ratings.json               # 评级数据
viewer/
  ├── templates/
  │   └── rating.html            # 页面模板
  └── static/
      ├── rating.js              # 前端逻辑
      └── rating.css             # 样式
deploy/
  ├── rating_deploy_guide.md     # 部署指南
  └── deploy_rating.sh           # 部署脚本
logs/
  └── rating_app.log             # 应用日志
```

## 联系支持

如有问题，请查看日志文件或联系技术支持。
